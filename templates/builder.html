<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Blog Builder + Assets</title>
    <style>
        :root { --primary: #6366f1; --secondary: #10b981; --bg: #f8fafc; --text: #334155; --dark: #1e293b; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; height: 100vh; display: flex; overflow: hidden; background: var(--bg); }
        
        .sidebar { width: 420px; background: #fff; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; z-index: 10; }
        .tabs { display: flex; border-bottom: 1px solid #e2e8f0; background: #f1f5f9; }
        .tab { flex: 1; padding: 14px; text-align: center; cursor: pointer; font-weight: 600; color: #64748b; border: none; transition: 0.2s; }
        .tab.active { background: #fff; color: var(--primary); border-bottom: 2px solid var(--primary); }

        .content-area { flex: 1; padding: 20px; display: none; flex-direction: column; gap: 12px; overflow-y: auto; }
        .content-area.active { display: flex; }

        h3 { font-size: 1.1rem; margin: 0; color: var(--dark); }
        p { font-size: 0.85rem; color: #64748b; margin: 0; }
        textarea { width: 100%; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; outline: none; padding: 12px; resize: none; font-family: inherit; }
        textarea:focus { border-color: var(--primary); }
        
        .code-editor { background: var(--dark); color: #a5b4fc; font-family: monospace; font-size: 12px; padding: 15px; border: none; flex: 1; }

        button { width: 100%; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; transition: 0.2s; }
        .btn-primary { background: var(--primary); }
        .btn-secondary { background: var(--secondary); }
        button:disabled { background: #94a3b8; cursor: wait; }

        /* UPLOAD STYLES */
        .upload-box { border: 2px dashed #cbd5e1; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .upload-box:hover { border-color: var(--primary); background: #f0f9ff; }
        #uploadResult { margin-top: 10px; padding: 10px; background: #ecfdf5; border-radius: 8px; border: 1px solid var(--secondary); display: none; }
        .snippet-box { background: #fff; padding: 8px; border: 1px solid #ddd; font-family: monospace; font-size: 0.8rem; overflow-x: auto; white-space: nowrap; margin: 5px 0; }

        .preview-wrapper { flex: 1; display: flex; flex-direction: column; }
        .browser-bar { background: #fff; padding: 10px 20px; border-bottom: 1px solid #cbd5e1; display: flex; justify-content: space-between; align-items: center; }
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(14px); position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; }
        iframe { width: 100%; flex: 1; border: none; background: white; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('ai')">ü§ñ AI & Assets</button>
            <button class="tab" onclick="switchTab('code')">üíª Code</button>
        </div>

        <div id="ai-panel" class="content-area active">
            <section>
                <h3>AI Builder</h3>
                <p>Describe changes or paste asset snippets here.</p>
                <textarea id="prompt" style="height:100px;" placeholder="e.g. Add a hero section, or paste an image snippet..."></textarea>
                <button id="generateBtn" class="btn-primary" onclick="handleGenerate()">Run AI Update</button>
            </section>

            <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 15px 0;">

            <section>
                <h3>üìÅ Upload Assets (Images/Videos)</h3>
                <p>Upload files, then copy the HTML snippet.</p>
                
                <input type="file" id="fileInput" hidden accept="image/*,video/mp4,video/quicktime,video/webm">
                <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                    <span style="font-size: 1.5rem;">‚òÅÔ∏è</span><br>
                    Click to select file
                </div>
                
                <div id="uploadStatus" style="margin-top: 5px; font-size: 0.8rem; color: var(--primary);"></div>

                <div id="uploadResult">
                    <span style="font-weight: 600; color: var(--secondary); font-size: 0.9rem;">‚úÖ File Ready!</span>
                    <p style="margin-top:5px;">Copy this HTML snippet:</p>
                    <div class="snippet-box" id="snippetText"></div>
                    <button class="btn-secondary" onclick="copySnippet()" style="padding: 8px; font-size: 0.9rem;">Copy Snippet to Clipboard üìã</button>
                    <p style="margin-top: 8px; font-size: 0.75rem;">üëâ Now paste this snippet into the AI prompt above or the Code tab.</p>
                </div>
            </section>

            <button style="margin-top: auto; background: var(--dark);" onclick="window.location.href='/download'">Download HTML ‚¨áÔ∏è</button>
        </div>

        <div id="code-panel" class="content-area">
            <h3>Code Editor</h3>
            <p>Paste asset snippets directly here for precise control.</p>
            <textarea id="codeEditor" class="code-editor" spellcheck="false"></textarea>
            <button class="btn-primary" onclick="saveManualCode()">Save Changes</button>
        </div>
    </div>

    <div class="preview-wrapper">
        <div class="browser-bar">
            <span style="font-weight:600; font-size:0.9rem;">Live Preview</span>
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:0.8rem;">Visual Edit (Text Only)</span>
                <label class="switch"><input type="checkbox" id="visualToggle" onchange="toggleVisualEdit()"><span class="slider"></span></label>
                <button id="saveVisualBtn" onclick="saveVisualChanges()" style="display:none; width:auto; padding:5px 10px; background:#22c55e; font-size:0.8rem;">Save</button>
            </div>
        </div>
        <iframe id="previewFrame" src="/preview"></iframe>
    </div>

    <script>
        const iframe = document.getElementById('previewFrame');

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-area').forEach(c => c.classList.remove('active'));
            if(tab === 'ai') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('ai-panel').classList.add('active');
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('code-panel').classList.add('active');
                loadCodeIntoEditor();
            }
        }

        async function handleGenerate() {
            const prompt = document.getElementById('prompt').value;
            const btn = document.getElementById('generateBtn');
            if (!prompt) return;
            btn.disabled = true; btn.innerText = "Processing...";
            try {
                const res = await fetch('/generate', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt }) });
                const data = await res.json();
                if (data.success) { refreshPreview(); document.getElementById('prompt').value = ""; }
                else { alert("AI Error: " + data.error); }
            } catch (e) { alert("Network Error"); }
            btn.disabled = false; btn.innerText = "Run AI Update";
        }

        // --- NEW: FILE UPLOAD HANDLING ---
        document.getElementById('fileInput').addEventListener('change', handleUpload);

        async function handleUpload() {
            const fileInput = document.getElementById('fileInput');
            const status = document.getElementById('uploadStatus');
            const resultBox = document.getElementById('uploadResult');

            if (fileInput.files.length === 0) return;

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);

            status.innerText = "Uploading " + file.name + "...";
            resultBox.style.display = "none";

            try {
                const res = await fetch('/upload_asset', { method: 'POST', body: formData });
                const data = await res.json();

                if (data.success) {
                    status.innerText = "";
                    document.getElementById('snippetText').innerText = data.snippet;
                    resultBox.style.display = "block";
                } else {
                    status.innerText = "Error: " + data.error;
                    alert("Upload failed: " + data.error);
                }
            } catch (e) {
                status.innerText = "Network Error";
                console.error(e);
            }
            fileInput.value = ''; // Reset input
        }

        function copySnippet() {
            const snippet = document.getElementById('snippetText').innerText;
            navigator.clipboard.writeText(snippet).then(() => {
                alert("Snippet copied! Now paste it into the AI prompt or Code editor.");
            });
        }
        // ---------------------------------


        async function loadCodeIntoEditor() {
            const res = await fetch('/get_code');
            const data = await res.json();
            document.getElementById('codeEditor').value = data.code;
        }

        async function saveManualCode() {
            const code = document.getElementById('codeEditor').value;
            await fetch('/save_code', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ code }) });
            refreshPreview();
        }

        function toggleVisualEdit() {
            const isOn = document.getElementById('visualToggle').checked;
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.body.contentEditable = isOn ? "true" : "false";
            doc.designMode = isOn ? "on" : "off";
            document.getElementById('saveVisualBtn').style.display = isOn ? "inline-block" : "none";
            if(isOn) alert("Visual Mode Active: Edit TEXT by clicking on it. To move images/videos, use the Code tab or AI prompts.");
        }

        async function saveVisualChanges() {
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.body.contentEditable = "false";
            const fullHTML = "<!DOCTYPE html>\n<html>" + doc.documentElement.innerHTML + "</html>";
            await fetch('/save_code', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ code: fullHTML }) });
            if(document.getElementById('visualToggle').checked) doc.body.contentEditable = "true";
            alert("Visual changes saved!");
        }

        function refreshPreview() {
            // Add timestamp to force reload images
            iframe.src = '/preview?t=' + new Date().getTime(); 
        }
    </script>
</body>
</html>